---
import { ClientRouter } from "astro:transitions";
import "../styles/global.css";

interface Props {
  title: string;
  description?: string;
}

const {
  title = "İsmet ALP | Portfolio",
  description = "Game Developer & Digital Artist",
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ClientRouter />
  </head>
  <body>
    <!-- Aurora Background -->
    <div id="aurora-bg" class="aurora-bg" transition:persist></div>
    <canvas id="spaceCanvas"></canvas>

    <div class="site-wrapper">
      <header class="site-header" transition:persist>
        <div class="container header-inner">
          <a href="/" class="logo">İSMET<span class="dot">.</span>ALP</a>
          <div class="header-actions">
            <nav>
              <a href="/experience">
                <i18n lang="en" data-i18n="nav-experience">Experience</i18n>
                <i18n lang="tr" hidden data-i18n="nav-experience">Deneyim</i18n>
              </a>
              <a href="/projects">
                <i18n lang="en" data-i18n="nav-projects">Projects</i18n>
                <i18n lang="tr" hidden data-i18n="nav-projects">Projeler</i18n>
              </a>
              <a href="/blog">
                <i18n lang="en" data-i18n="nav-blog">Jurnals</i18n>
                <i18n lang="tr" hidden data-i18n="nav-blog">Yazılar</i18n>
              </a>
              <a href="/about">
                <i18n lang="en" data-i18n="nav-about">About</i18n>
                <i18n lang="tr" hidden data-i18n="nav-about">Hakkımda</i18n>
              </a>
            </nav>
          </div>
        </div>
      </header>

      <div class="lang-switcher" data-lang-switcher transition:persist>
        <button
          class="lang-switcher__toggle"
          type="button"
          data-lang-toggle
          aria-haspopup="listbox"
          aria-expanded="false"
        >
          <span class="sr-only">
            <i18n lang="en" data-i18n="lang-label">Language</i18n>
            <i18n lang="tr" hidden data-i18n="lang-label">Dil</i18n>
          </span>
          <span class="lang-switcher__current" data-lang-current>EN</span>
        </button>
        <div
          class="lang-switcher__menu"
          role="listbox"
          aria-label="Language selector"
        >
          <button class="lang-option" type="button" data-lang="en">
            EN
          </button>
          <button class="lang-option" type="button" data-lang="tr">
            TR
          </button>
        </div>
      </div>

      <main>
        <slot />
      </main>

      <footer class="site-footer">
        <div class="container">
          <p>
            &copy; {new Date().getFullYear()} İsmet ALP. 
            <i18n lang="en" data-i18n="footer-powered">
              Powered by <a href="https://astro.build" target="_blank">Astro</a
              >.
            </i18n>
            <i18n lang="tr" hidden data-i18n="footer-powered">
              Astro ile güçlendirildi.
            </i18n>
          </p>
        </div>
      </footer>
    </div>

    <div class="theme-switcher" data-theme-switcher transition:persist hidden>
      <div class="theme-switcher__title">
        <i18n lang="en" data-i18n="theme-title">Color Theme</i18n>
        <i18n lang="tr" hidden data-i18n="theme-title">Renk Teması</i18n>
      </div>
      <div
        class="theme-switcher__panel"
        role="listbox"
        aria-label="Color themes"
      >
        <button
          class="theme-swatch"
          type="button"
          data-theme="orijinal"
          aria-label="Orijinal"
          style="
            --swatch-1: var(--theme-orijinal-1);
            --swatch-2: var(--theme-orijinal-2);
            --swatch-3: var(--theme-orijinal-3);
          "
        >
          <span class="theme-swatch__label">Orijinal</span>
        </button>
        <button
          class="theme-swatch"
          type="button"
          data-theme="koral"
          aria-label="Koral"
          style="
            --swatch-1: var(--theme-koral-1);
            --swatch-2: var(--theme-koral-2);
            --swatch-3: var(--theme-koral-3);
          "
        >
          <span class="theme-swatch__label">Koral</span>
        </button>
        <button
          class="theme-swatch"
          type="button"
          data-theme="amber"
          aria-label="Amber"
          style="
            --swatch-1: var(--theme-amber-1);
            --swatch-2: var(--theme-amber-2);
            --swatch-3: var(--theme-amber-3);
          "
        >
          <span class="theme-swatch__label">Amber</span>
        </button>
        <button
          class="theme-swatch"
          type="button"
          data-theme="fusya"
          aria-label="Fusya"
          style="
            --swatch-1: var(--theme-fusya-1);
            --swatch-2: var(--theme-fusya-2);
            --swatch-3: var(--theme-fusya-3);
          "
        >
          <span class="theme-swatch__label">Fusya</span>
        </button>
        <button
          class="theme-swatch"
          type="button"
          data-theme="toprak"
          aria-label="Toprak"
          style="
            --swatch-1: var(--theme-toprak-1);
            --swatch-2: var(--theme-toprak-2);
            --swatch-3: var(--theme-toprak-3);
          "
        >
          <span class="theme-swatch__label">Toprak</span>
        </button>
        <button
          class="theme-swatch"
          type="button"
          data-theme="seftali"
          aria-label="Seftali"
          style="
            --swatch-1: var(--theme-seftali-1);
            --swatch-2: var(--theme-seftali-2);
            --swatch-3: var(--theme-seftali-3);
          "
        >
          <span class="theme-swatch__label">Seftali</span>
        </button>
        <button
          class="theme-swatch"
          type="button"
          data-theme="alev"
          aria-label="Alev"
          style="
            --swatch-1: var(--theme-alev-1);
            --swatch-2: var(--theme-alev-2);
            --swatch-3: var(--theme-alev-3);
          "
        >
          <span class="theme-swatch__label">Alev</span>
        </button>
        <button
          class="theme-swatch"
          type="button"
          data-theme="Alp"
          aria-label="Alp"
          style="
            --swatch-1: var(--theme-alp-1);
            --swatch-2: var(--theme-alp-2);
            --swatch-3: var(--theme-alp-3);
          "
        >
          <span class="theme-swatch__label">Alp</span>
        </button>
        <button
          class="theme-swatch"
          type="button"
          data-theme="Alp 2"
          aria-label="Alp 2"
          style="
            --swatch-1: var(--theme-alp-2-1);
            --swatch-2: var(--theme-alp-2-2);
            --swatch-3: var(--theme-alp-2-3);
          "
        >
          <span class="theme-swatch__label">Alp 2</span>
        </button>
        <button
          class="theme-swatch"
          type="button"
          data-theme="Alp TR"
          aria-label="Alp TR"
          style="
            --swatch-1: var(--theme-alp-tr-1);
            --swatch-2: var(--theme-alp-tr-2);
            --swatch-3: var(--theme-alp-tr-3);
          "
        >
          <span class="theme-swatch__label">Alp TR</span>
        </button>
      </div>
    </div>

    <script>
      // Star field animation
      // Module-level variables
      let canvas: HTMLCanvasElement | null = null;
      let ctx: CanvasRenderingContext2D | null = null;
      let bgDiv: HTMLElement | null = null;
      let starColor = "255, 255, 255";
      let width = window.innerWidth;
      let height = 0;
      let particles: Star[] = [];
      let mouseX = 0,
          mouseY = 0;
        let targetX = 0,
          targetY = 0;
        let animationFrameId = 0;
        let resizeObserver: ResizeObserver | null = null;
        let listenersBound = false;
        let poolHeight = 10000;
        let lastMeasure = 0;
        const measureInterval = 250; // ms

        const config = {
          starPoolSize: 2000,
          starHorizon: 0.8,
          starFadeStrength: 3.0,
          parallax: true,
        };

        // Pre-generated star pool
        const starPool: Star[] = [];

      const random = (min: number, max: number) =>
        Math.random() * (max - min) + min;

      const updateStarColor = () => {
        const colorValue = getComputedStyle(document.documentElement)
          .getPropertyValue("--color-star-rgb")
          .trim();
        if (colorValue) {
          starColor = colorValue;
        }
      };

        const getContentHeight = () => {
          const wrapper = document.querySelector(".site-wrapper");
          if (!wrapper) return window.innerHeight;
          return Math.max(
            window.innerHeight,
            wrapper.getBoundingClientRect().height
          );
        };

        class Star {
          x = 0;
          y = 0;
          size = 0;
          z = 0;
          baseAlpha = 0;
          twinklePhase = 0;

          draw() {
            this.twinklePhase += 0.05;
            let alpha = this.baseAlpha + Math.sin(this.twinklePhase) * 0.15;

            const progress = this.y / height;
            if (progress > config.starHorizon) {
              const depth =
                (progress - config.starHorizon) / (1 - config.starHorizon);
              alpha -= depth * config.starFadeStrength;
            }

            if (alpha <= 0.02) return;

            const dx = this.x + (config.parallax ? targetX * this.z : 0);
            const dy = this.y + (config.parallax ? targetY * this.z : 0);

            if (ctx) {
              ctx.beginPath();
              ctx.fillStyle = `rgba(${starColor}, ${alpha})`;
              ctx.arc(dx, dy, this.size, 0, Math.PI * 2);
              ctx.fill();
            }
          }
        }

        function initStarPool(customHeight?: number) {
          starPool.length = 0;
          poolHeight =
            customHeight ?? Math.max(height || window.innerHeight, 10000);

          for (let i = 0; i < config.starPoolSize; i++) {
            const star = new Star();
            star.x = Math.random() * width;
            star.y = Math.random() * poolHeight;
            star.size = Math.random() < 0.95 ? random(0.5, 1.5) : random(2, 3);
            star.z = random(0.1, 0.4);
            star.baseAlpha = random(0.3, 0.9);
            star.twinklePhase = random(0, Math.PI * 2);
            starPool.push(star);
          }
        }

        function resize() {
          if (!canvas || !ctx) return;

          const newWidth = window.innerWidth;
          const newHeight = getContentHeight();

          if (!newHeight) return;

          width = newWidth;
          height = newHeight;
          canvas.width = width;
          canvas.height = height;
          if (bgDiv) bgDiv.style.height = height + "px";

          const desiredPoolHeight = Math.max(height, 10000);
          if (starPool.length === 0 || desiredPoolHeight > poolHeight) {
            initStarPool(desiredPoolHeight);
          }

          // Filter stars within current page height
          particles = starPool.filter((star) => star.y <= height);
        }

        function animate(_timestamp: number) {
          if (!ctx) return;
          ctx.clearRect(0, 0, width, height);

          if (_timestamp - lastMeasure > measureInterval) {
            lastMeasure = _timestamp;
            resize();
          }

          targetX += (mouseX - targetX) * 0.05;
          targetY += (mouseY - targetY) * 0.05;

          particles.forEach((p) => p.draw());

          animationFrameId = requestAnimationFrame(animate);
        }

        const handleMouseMove = (e: MouseEvent) => {
          if (!config.parallax) return;
          const cx = window.innerWidth / 2;
          const cy = window.innerHeight / 2;
          mouseX = (e.clientX - cx) * 0.05;
          mouseY = (e.clientY - cy) * 0.05;
        };

        function observeContentHeight() {
          if (!("ResizeObserver" in window)) return;
          if (resizeObserver) resizeObserver.disconnect();
          resizeObserver = new ResizeObserver(() => resize());
          const mainEl = document.querySelector("main");
          if (mainEl) resizeObserver.observe(mainEl);
          if (document.body) resizeObserver.observe(document.body);
          if (document.documentElement)
            resizeObserver.observe(document.documentElement);
        }

        function scheduleStabilizeResizes() {
          resize();
          requestAnimationFrame(() => resize());
          setTimeout(() => resize(), 150);
        }

        function initStars() {
          canvas = document.getElementById("spaceCanvas") as HTMLCanvasElement;
          if (!canvas) return;
          ctx = canvas.getContext("2d");
          if (!ctx) return;
          bgDiv = document.querySelector(".aurora-bg") as HTMLElement;
          if (!bgDiv) return;
          updateStarColor();

          // Initialize star pool
          if (starPool.length === 0) {
            initStarPool();
          }

          // Set up event listeners once
          if (!listenersBound) {
            window.addEventListener("resize", resize);
            window.addEventListener("mousemove", handleMouseMove);
            window.addEventListener("load", scheduleStabilizeResizes);
            document.addEventListener("click", (e) => {
              const target = (e.target as HTMLElement | null)?.closest("a");
              if (!target) return;
              if (!(target as HTMLElement).matches("header nav a")) return;
              setTimeout(() => scheduleStabilizeResizes(), 80);
            });
            listenersBound = true;
          }

          observeContentHeight();

          // Start
          scheduleStabilizeResizes();
          if (animationFrameId) cancelAnimationFrame(animationFrameId);
          animationFrameId = requestAnimationFrame(animate);
        }

        // Update on page load and transitions
        document.addEventListener("astro:page-load", () => {
          initStars();
        });
        document.addEventListener("astro:after-swap", () => {
          // On page transition, recalculate height and reattach observer
          requestAnimationFrame(() => {
            observeContentHeight();
            scheduleStabilizeResizes();
          });
        });

        // Initial call
        initStars();
    </script>
  </body>
</html>

<style>
  html {
    background-color: var(--color-bg);
    background-image: linear-gradient(
      to bottom,
      var(--color-bg) 0%,
      var(--color-bg) 80%,
      var(--color-black) 100%
    );
    background-attachment: scroll;
    min-height: 100%;
  }

  body {
    margin: 0;
    min-height: 100vh;
    position: relative;
    background: var(--color-transparent);
  }

  .site-wrapper {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    width: 100%;
    position: relative;
    z-index: 1;
  }

  .site-header {
    position: sticky;
    top: 2rem;
    z-index: 100;
    margin: 0 auto;
    max-width: 800px;
    width: 100%;
  }

  .header-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    padding: 1rem 2rem;
    background: var(--color-white-05);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--color-white-10);
    border-radius: var(--radius-full);
    box-shadow: 0 10px 30px var(--color-black-20);
  }

  .logo {
    font-family: var(--font-serif);
    font-weight: 700;
    font-size: 1.25rem;
    letter-spacing: 0.05em;
  }

  .dot {
    color: var(--color-logo-dot);
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  nav {
    display: flex;
    gap: 2rem;
  }

  nav a {
    font-size: 0.9rem;
    font-weight: 400;
    opacity: 0.7;
  }

  nav a:hover {
    opacity: 1;
    text-shadow: 0 0 10px var(--color-white-50);
  }

  main {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding-top: 4rem;
  }

  .site-footer {
    padding: 4rem 0;
    text-align: center;
    border-top: 1px solid var(--color-white-05);
    margin-top: auto;
    padding-top: 6rem;
    background: linear-gradient(
      to top,
      var(--color-black-80),
      var(--color-transparent)
    );
    width: 100%;
  }

  /* Aurora Background - Scrollable */
  .aurora-bg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    min-height: 100vh;
    z-index: -1;
    background: linear-gradient(
      135deg,
      var(--color-bg) 0%,
      var(--color-bg-deep) 50%,
      var(--color-bg) 100%
    );
    overflow: hidden;
    pointer-events: none;
  }

  .aurora-bg::before {
    content: "";
    position: absolute;
    width: 200%;
    height: 200%;
    background: radial-gradient(
      circle at 30% 50%,
      var(--color-aurora-bg-spot-1) 0%,
      var(--color-transparent) 50%
    );
    animation: aurora-move 20s ease-in-out infinite;
    transform: translateZ(0); /* GPU acceleration */
  }

  .aurora-bg::after {
    content: "";
    position: absolute;
    width: 200%;
    height: 200%;
    background: radial-gradient(
      circle at 70% 50%,
      var(--color-aurora-bg-spot-2) 0%,
      var(--color-transparent) 50%
    );
    animation: aurora-move 25s ease-in-out infinite reverse;
    transform: translateZ(0); /* GPU acceleration */
  }

  @keyframes aurora-move {
    0% {
      transform: scale(1) translateZ(0);
    }
    50% {
      transform: scale(1.1) translateZ(0);
    }
    100% {
      transform: scale(1) translateZ(0);
    }
  }

  canvas#spaceCanvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
    pointer-events: none;
  }

  .theme-switcher {
    position: fixed;
    right: 1.5rem;
    bottom: 1.5rem;
    z-index: 200;
    display: none;
    flex-direction: column;
    gap: 0.5rem;
    max-width: 260px;
    font-family: var(--font-sans);
  }

  .lang-switcher {
    position: fixed;
    top: 1.5rem;
    right: 1.5rem;
    z-index: 220;
    display: inline-flex;
    align-items: center;
    padding-bottom: 0.35rem;
    font-family: var(--font-sans);
  }

  .theme-switcher__title {
    font-size: 0.7rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--color-text-70);
    padding: 0 0.25rem;
  }

  .theme-switcher__panel {
    display: grid;
    grid-template-columns: repeat(2, minmax(110px, 1fr));
    gap: 0.6rem;
    padding: 0.75rem;
    border-radius: 16px;
    background: var(--color-bg-60);
    border: 1px solid var(--color-white-12);
    box-shadow: 0 10px 30px var(--color-black-35);
    backdrop-filter: blur(16px);
  }

  .lang-switcher__toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0;
    border: none;
    background: transparent;
    color: var(--color-text);
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    cursor: pointer;
    transition:
      color 0.2s ease,
      opacity 0.2s ease;
  }

  .lang-switcher__toggle {
    opacity: 0.6;
  }

  .lang-switcher__toggle:hover,
  .lang-switcher:focus-within .lang-switcher__toggle {
    opacity: 1;
    color: var(--color-lang-option-active-start);
  }

  .lang-switcher__menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: auto;
    min-width: 0;
    width: max-content;
    display: grid;
    gap: 0.4rem;
    justify-items: start;
    padding: 0;
    border-radius: 14px;
    background: transparent;
    border: none;
    box-shadow: none;
    backdrop-filter: none;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-6px);
    pointer-events: none;
    transition:
      opacity 0.2s ease,
      transform 0.2s ease,
      visibility 0.2s ease;
  }

  .lang-switcher:hover .lang-switcher__menu,
  .lang-switcher:focus-within .lang-switcher__menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }

  .lang-option {
    width: auto;
    padding: 0.25rem 0;
    border-radius: 0;
    border: none;
    background: transparent;
    color: var(--color-lang-option-text);
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    text-align: left;
    transition:
      transform 0.2s ease,
      background 0.2s ease,
      color 0.2s ease;
  }

  .lang-option:hover {
    transform: translateY(-1px);
    color: var(--color-lang-option-active-start);
  }

  .lang-option[data-active="true"] {
    display: none;
  }

  .theme-swatch {
    position: relative;
    height: 44px;
    border-radius: 12px;
    border: 1px solid var(--color-white-20);
    padding: 0.35rem 0.4rem;
    background: linear-gradient(
      135deg,
      var(--swatch-1),
      var(--swatch-2),
      var(--swatch-3)
    );
    color: var(--color-white-95);
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    display: flex;
    align-items: flex-end;
    justify-content: flex-start;
    cursor: pointer;
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease,
      border-color 0.2s ease;
  }

  .theme-swatch::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: linear-gradient(
      to bottom,
      var(--color-black-0),
      var(--color-black-25)
    );
  }

  .theme-swatch__label {
    position: relative;
    z-index: 1;
    text-shadow: 0 2px 10px var(--color-black-45);
  }

  .theme-swatch:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px var(--color-black-35);
  }

  .theme-swatch[data-active="true"] {
    border-color: var(--color-white-90);
    box-shadow:
      0 0 0 2px var(--color-white-75),
      0 12px 22px var(--color-black-35);
  }

  @media (max-width: 720px) {
    .lang-switcher {
      top: 1rem;
      right: 1rem;
    }

    .theme-switcher {
      left: 1rem;
      right: 1rem;
      bottom: 1rem;
      max-width: none;
      align-items: center;
    }

    .theme-switcher__panel {
      width: 100%;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    .theme-swatch {
      height: 38px;
      font-size: 0.55rem;
    }

    .header-inner {
      padding: 1rem 1.25rem;
    }

    .header-actions {
      width: 100%;
      justify-content: space-between;
      gap: 1rem;
    }

    nav {
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .lang-switcher__menu {
      right: 0;
    }
  }
</style>

<script>
  // Scroll Reveal Logic: Dynamic Wave
  const observerOptions = {
    root: null,
    rootMargin: "0px",
    threshold: 0.15,
  };

  const observer = new IntersectionObserver((entries) => {
    // Filter only intersecting entries
    const intersectingEntries = entries.filter((e) => e.isIntersecting);

    // Sort them by their visual position (Left to Right, Top to Bottom)
    intersectingEntries.sort((a, b) => {
      return a.boundingClientRect.left - b.boundingClientRect.left;
    });

    intersectingEntries.forEach((entry, index) => {
      const target = entry.target;
      // Apply dynamic delay per item in this batch
      // 150ms stagger per item creates the wave
      if (target instanceof HTMLElement) {
        target.style.transitionDelay = `${index * 150}ms`;
      }

      if (target instanceof HTMLElement) {
        target.classList.add("visible");
        observer.unobserve(target);
      }
    });
  }, observerOptions);

  const revealProjectCards = () => {
    const hiddenElements = document.querySelectorAll(".project-card");
    if (!("IntersectionObserver" in window)) {
      hiddenElements.forEach((el) => {
        if (el instanceof HTMLElement) el.classList.add("visible");
      });
      return;
    }

    observer.disconnect();
    hiddenElements.forEach((el) => {
      if (!(el instanceof HTMLElement)) return;
      el.classList.remove("visible");
      el.style.transitionDelay = "0ms";
      observer.observe(el);
    });
  };

  // Setup observer on page load and after view transitions
  document.addEventListener("DOMContentLoaded", revealProjectCards);
  document.addEventListener("astro:page-load", revealProjectCards);
  document.addEventListener("astro:after-swap", revealProjectCards);
  revealProjectCards();
</script>

<script>
  const themeStorageKey = "demo-portfolio-4-theme";
  const defaultThemeId = "Alp 2";

  const normalizeHex = (value) => {
    const trimmed = value.replace("#", "").trim();
    if (trimmed.length === 3) {
      return trimmed
        .split("")
        .map((char) => char + char)
        .join("");
    }
    return trimmed;
  };

  const hexToRgb = (value) => {
    const normalized = normalizeHex(value);
    if (normalized.length !== 6) return "";
    const r = parseInt(normalized.slice(0, 2), 16);
    const g = parseInt(normalized.slice(2, 4), 16);
    const b = parseInt(normalized.slice(4, 6), 16);
    return `${r}, ${g}, ${b}`;
  };

  const resolveCssValue = (value) => {
    const trimmed = value.trim();
    if (!trimmed) return "";
    const varMatch = trimmed.match(/var\((--[^)]+)\)/);
    if (!varMatch) return trimmed;
    return getComputedStyle(document.documentElement)
      .getPropertyValue(varMatch[1])
      .trim();
  };

  const colorToRgb = (value) => {
    const resolved = resolveCssValue(value);
    if (!resolved) return "";
    if (resolved.startsWith("rgb")) {
      const match = resolved.match(/rgba?\(([^)]+)\)/i);
      if (!match) return "";
      return match[1]
        .split(",")
        .slice(0, 3)
        .map((part) => part.trim())
        .join(", ");
    }
    return hexToRgb(resolved);
  };

  const applyTheme = (theme) => {
    const root = document.documentElement;
    root.style.setProperty("--color-aurora-1", theme.aurora1);
    root.style.setProperty("--color-aurora-2", theme.aurora2);
    root.style.setProperty("--color-aurora-3", theme.aurora3);

    const aurora1Rgb = colorToRgb(theme.aurora1);
    const aurora2Rgb = colorToRgb(theme.aurora2);
    const aurora3Rgb = colorToRgb(theme.aurora3);

    if (aurora1Rgb) root.style.setProperty("--color-aurora-1-rgb", aurora1Rgb);
    if (aurora2Rgb) root.style.setProperty("--color-aurora-2-rgb", aurora2Rgb);
    if (aurora3Rgb) root.style.setProperty("--color-aurora-3-rgb", aurora3Rgb);
  };

  const setActiveTheme = (buttons, activeId) => {
    buttons.forEach((button) => {
      const isActive = button.dataset.theme === activeId;
      button.dataset.active = isActive ? "true" : "false";
      button.setAttribute("aria-pressed", isActive ? "true" : "false");
    });
  };

  const getThemeFromButton = (button) => {
    const themeId = button.dataset.theme;
    if (!themeId) return null;
    const styles = getComputedStyle(button);
    const aurora1 = resolveCssValue(styles.getPropertyValue("--swatch-1"));
    const aurora2 = resolveCssValue(styles.getPropertyValue("--swatch-2"));
    const aurora3 = resolveCssValue(styles.getPropertyValue("--swatch-3"));
    if (!aurora1 || !aurora2 || !aurora3) return null;
    return { id: themeId, aurora1, aurora2, aurora3 };
  };

  const initThemeSwitcher = () => {
    const switcher = document.querySelector("[data-theme-switcher]");
    if (!switcher) return;

    const buttons = Array.from(switcher.querySelectorAll(".theme-swatch"));
    if (!buttons.length) return;

    const themes = buttons
      .map((button) => getThemeFromButton(button))
      .filter(Boolean);
    const themeMap = new Map(themes.map((theme) => [theme.id, theme]));

    const applyThemeById = (id) => {
      const theme = themeMap.get(id);
      if (!theme) return;
      applyTheme(theme);
      setActiveTheme(buttons, id);
      try {
        sessionStorage.setItem(themeStorageKey, id);
      } catch (error) {
        console.warn("Theme storage unavailable", error);
      }
    };

    if (switcher.dataset.initialized !== "true") {
      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const theme = getThemeFromButton(button);
          if (theme) applyThemeById(theme.id);
        });
      });
      switcher.dataset.initialized = "true";
    }

    let savedThemeId = null;
    try {
      savedThemeId = sessionStorage.getItem(themeStorageKey);
    } catch (error) {
      console.warn("Theme storage unavailable", error);
    }

    if (savedThemeId && themeMap.has(savedThemeId)) {
      applyThemeById(savedThemeId);
      return;
    }

    if (themeMap.has(defaultThemeId)) {
      applyThemeById(defaultThemeId);
      return;
    }

    const currentAurora1 = getComputedStyle(document.documentElement)
      .getPropertyValue("--color-aurora-1")
      .trim()
      .toLowerCase();
    const currentTheme = themes.find(
      (theme) => theme.aurora1.toLowerCase() === currentAurora1
    );

    if (currentTheme) {
      setActiveTheme(buttons, currentTheme.id);
    } else {
      setActiveTheme(buttons, themes[0]?.id);
    }
  };

  document.addEventListener("astro:page-load", initThemeSwitcher);
  document.addEventListener("astro:after-swap", initThemeSwitcher);
</script>

<script>
  const langStorageKey = "demo-portfolio-4-lang";
  const defaultLang = "en";
  let activeLang = defaultLang;

  const normalizeLang = (value) => (value || "").trim().toLowerCase();
  const getLangAttr = (node) => normalizeLang(node.getAttribute("lang"));

  const applyLanguage = (lang) => {
    const normalized = normalizeLang(lang) || defaultLang;
    document.documentElement.lang = normalized;
    document.documentElement.dataset.lang = normalized;
    activeLang = normalized;

    const groups = new Map();
    document.querySelectorAll("i18n[lang]").forEach((node) => {
      const key = node.dataset.i18n || "__default__";
      const parent = node.parentElement;
      if (!parent) return;

      let parentGroups = groups.get(parent);
      if (!parentGroups) {
        parentGroups = new Map();
        groups.set(parent, parentGroups);
      }

      const items = parentGroups.get(key) || [];
      items.push(node);
      parentGroups.set(key, items);
    });

    groups.forEach((parentGroups) => {
      parentGroups.forEach((nodes) => {
        nodes.forEach((node) => {
          if (node instanceof HTMLElement) node.hidden = true;
        });

        const match = nodes.find(
          (node) => getLangAttr(node) === normalized
        );
        const fallback = nodes.find(
          (node) => getLangAttr(node) === defaultLang
        );
        const next = match || fallback || nodes[0];
        if (next instanceof HTMLElement) next.hidden = false;
      });
    });
  };

  const setActiveLanguage = (buttons, lang, currentLabel) => {
    buttons.forEach((button) => {
      const isActive = normalizeLang(button.dataset.lang) === lang;
      button.dataset.active = isActive ? "true" : "false";
      button.setAttribute("aria-pressed", isActive ? "true" : "false");
    });

    if (currentLabel) {
      currentLabel.textContent = lang.toUpperCase();
    }
  };

  const observeI18n = () => {
    if (observeI18n.initialized || !document.body) return;
    const observer = new MutationObserver((mutations) => {
      const hasI18n = mutations.some((mutation) =>
        Array.from(mutation.addedNodes).some((node) => {
          if (!(node instanceof HTMLElement)) return false;
          return (
            node.matches("i18n[lang]") || node.querySelector("i18n[lang]")
          );
        })
      );
      if (hasI18n) applyLanguage(activeLang);
    });
    observer.observe(document.body, { childList: true, subtree: true });
    observeI18n.initialized = true;
  };
  observeI18n.initialized = false;

  const initLanguageSwitcher = () => {
    const switcher = document.querySelector("[data-lang-switcher]");
    if (!switcher) {
      applyLanguage(defaultLang);
      return;
    }

    const buttons = Array.from(switcher.querySelectorAll(".lang-option"));
    if (!buttons.length) return;
    const currentLabel = switcher.querySelector("[data-lang-current]");

    const availableLangs = new Set(
      buttons.map((button) => normalizeLang(button.dataset.lang))
    );

    const applyLang = (lang) => {
      const nextLang = availableLangs.has(lang) ? lang : defaultLang;
      applyLanguage(nextLang);
      setActiveLanguage(buttons, nextLang, currentLabel);
      try {
        localStorage.setItem(langStorageKey, nextLang);
      } catch (error) {
        console.warn("Language storage unavailable", error);
      }
    };

    if (switcher.dataset.initialized !== "true") {
      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const lang = normalizeLang(button.dataset.lang);
          if (lang) applyLang(lang);
        });
      });
      switcher.dataset.initialized = "true";
    }

    let savedLang = null;
    try {
      savedLang = normalizeLang(localStorage.getItem(langStorageKey));
    } catch (error) {
      console.warn("Language storage unavailable", error);
    }

    applyLang(savedLang || defaultLang);
    observeI18n();
  };

  document.addEventListener("astro:page-load", initLanguageSwitcher);
  document.addEventListener("astro:after-swap", initLanguageSwitcher);
</script>
